name: Releaser

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  paths-filter:
    runs-on: ubuntu-latest
    outputs:
      output1: ${{ steps.filter.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            workflows:
              - 'desktop/**'
  build_and_release:
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest ]
        extension: [ deb, exe ]
        include:
          - os: ubuntu-latest
            extension: deb
          - os: windows-latest
            extension: exe
    runs-on: ${{ matrix.os }}
    name: Build for ${{ matrix.os }}
    # Wait from the paths-filter to be completed before starting next-job
    needs: paths-filter
    if: needs.paths-filter.outputs.output1 == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'adopt'
          java-version: '17'
          java-package: jdk
          cache: 'gradle'
      - name: Build
        id: build
        run: bash ./gradlew desktop:packageDistributionForCurrentOS --stacktrace
      - name: Artifact
        uses: actions/upload-artifact@v3
        with:
          name: Artifact
          path: ./desktop/build/compose/binaries/main/dev/*.${{ matrix.extension }}
